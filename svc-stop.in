#!/bin/sh
set -e
if [ "$1X" = X ]; then
	echo usage: svc-stop service
	exit 1
fi

cd ${SVSCANDIR-/service}
PATH="$PATH:/usr/local/bin"
export PATH

if ! [ -d "$1" -o -L "$1" ]; then
  echo "Service '$1' does not exist."
  exit 1
fi

stop() {
  touch "$1"/down
  if svc-isup "$1"; then
    svc -d "$1"
    if svc-waitdown "$1"; then
      echon " $1"
    else
      echo " Failed!"
      exit 1
    fi
  else
    echon " $1 (already down)"
  fi
}

echon "Stopping $1: "

stop "$1"

if [ -d "$1/log" ]; then
  stop "$1/log"
fi

if [ -L "$1" ]; then
  link="`readlink "$1"`"
  rm -f "$1"
  if [ -d "$link" ]; then
    svc -dx "$link"
    echon " supervise"
  fi
fi

echo " done."
