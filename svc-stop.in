#!/bin/sh
set -e
if [ "$1X" = X ]; then
	echo usage: svc-stop service
	exit 1
fi

svc="$1"
cd ${SVSCANDIR-/service}
PATH="$PATH:/usr/local/bin"
export PATH

if ! [ -d "$svc" -o -L "$svc" ]; then
  echo "Service '$svc' does not exist."
  exit 1
fi

stop() {
  touch "$1"/down
  if svc-isup "$1"; then
    svc -d "$1"
    if svc-waitdown "$1"; then
      echon "$1 "
    else
      echo "Failed!"
      exit 1
    fi
  else
    echon "$1 (already down) "
  fi
}

echon "Stopping $svc: "

stop "$svc"

if [ -d "$svc/log" ]; then
  stop "$svc/log"
fi

if [ -L "$svc" ]; then
  if cd "$svc" 2>/dev/null; then
    if [ -d log ]; then
      svc -dx log
    fi
    svc -dx .
    echon "supervise "
    cd ${SVSCANDIR-/service}
  fi
  rm -f "$svc"
fi

echo "done."
