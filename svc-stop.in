#!/bin/sh
set -e

fatal() {
  echo "svc-stop: Fatal error: $@" >&2
  exit 1
}

if [ "$1" = -q ]; then
  exec >/dev/null
  shift
fi

if [ "$1X" = X ]; then
  echo "usage: svc-stop [-q] service" >&2
  exit 1
fi

svc="$1"
cd ${SVSCANDIR-/service}
PATH="$PATH:/usr/local/bin"
export PATH

if ! [ -d "$svc" -o -L "$svc" ]; then
  fatal "Service '$svc' does not exist."
fi

stop() {
  touch "$1"/down
  if svc-isup "$1"; then
    svc -d "$1"
    if svc-waitdown "$1"; then
      echon "$1 "
    else
      fatal "Failed to stop '$1'."
    fi
  else
    echon "$1 (already down) "
  fi
}

echon "Stopping $svc: "

stop "$svc"

if [ -d "$svc/log" ]; then
  stop "$svc/log"
fi

echo "done."
