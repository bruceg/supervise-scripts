#!/bin/sh
set -e
if [ "X$1" = X ]; then
	echo "usage: svc-start service"
	exit 1
fi

svc="$1"

cd "${SVSCANDIR-/service}"
PATH="$PATH:/usr/local/bin"
export PATH

if ! [ -e "$svc" ]; then
  echo "Service '$svc' does not exist."
  exit 1
fi

start() {
  # Check the "run" file
  if [ ! -e "$1/run" ]; then
    echo "run file does not exist!"
    exit 1
  fi

  rm -f "$1/down"

  if ! svok "$1"; then
    echon "(supervise"
    count=1
    until svok "$1"; do
      echon .
      sleep 1
      let count=count+1
      if [ $count -gt ${SVCTIMEOUT-15} ]; then
        echo ") supervise did not start!"
        exit 1
      fi
    done
    echon ") "
  fi

  svc -u "$1"
  svc-waitup "$1"

  echon "$1 "
}

echon "Starting $svc: "

# Control the log process first, so that all messages are logged ...
if [ -d "$svc/log" ]; then
  chmod +t "$svc"
  start "$svc/log"
fi

# ... and then the main process.
start "$svc"

echo "done."
