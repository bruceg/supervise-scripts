#!/bin/sh

if [ -z "$BINDIR" ]; then
  echo "$0: BINDIR must be set"
  exit 1
fi

case `echo 'a\c'` in
  'a\c')
    echo 'Using echo -n'
    perl='s/echon "([^"]*)"/echo -n "\1"/; s/echon ([^;]*)/echo -n \1/'
    ;;
  'a')
    echo 'Using echo \\c'
    perl='s/echon "([^"]*)"/echo "\1\c"/; s/echon ([^;]*)/echo \1\\c/'
    ;;
  *)
    echo "Unrecognized output from echo!"
    exit 1
    ;;
esac

perl="$perl; s|\@BINDIR\@|$BINDIR|g"

process_template() {
  sed -e "s/@PROGRAM@/$2/g" template.sh
  tail +2 | perl -p -e "$perl"
}

process_notemplate() {
  perl -p -e "$perl"
}

process_list() {
  for file in "$@"
  do
    if ! [ -e $file ]
    then
      echo "$0: Skipping missing file '$file'"
    else
      out=`basename $file .in`
      echo "Processing $file => $out"
      if head -1 $file | grep template >/dev/null 2>&1
      then
        process_template <$file >$out
      else
        process_notemplate <$file >$out
      fi
      chmod +x $out
    fi
  done
}

process_list svc-*.in svscan-*.in
