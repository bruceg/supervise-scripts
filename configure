#!/bin/sh

expr=""

case `echo 'a\c'` in
  'a\c')
    echo 'Using echo -n'
    perl='s/echon "([^"]*)"/echo -n "\1"/; s/echon ([^;]*)/echo -n \1/'
    ;;
  'a')
    echo 'Using echo \\c'
    perl='s/echon "([^"]*)"/echo "\1\c"/; s/echon ([^;]*)/echo \1\\c/'
    ;;
  *)
    echo "Unrecognized output from echo!"
    exit 1
    ;;
esac

process() {
  {
    echo '#!/bin/sh'
    echo 'set -e'
    echo 'PATH="$PATH:/usr/local/bin"'
    echo 'export PATH'
    echo 'cd "${SVSCANDIR-/service}"'
    echo 'fatal() {'
    echo '  echo "'$2': Fatal error: $@" >&2'
    echo '  exit 1'
    echo '}'
    echo 'usage() {'
    echo '  args=$1; min=$2; max=$3; shift 3'
    echo '  if [ $args -lt $min -o $args -gt $max ]; then'
    echo '    echo "$0: usage: '$2' $@" >&2'
    echo '    exit 1'
    echo '  fi'
    echo '}'
    echo
    tail +2 $1 | perl -p -e "$perl"
  } >$2
  chmod +x $2
}

for file in "$@"; do
  out=`basename $file .in`
  echo "Processing $file -> $out"
  process $file $out
done
