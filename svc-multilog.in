#!/bin/sh
usage $# 1 1 "log-directory"
set -x

if [ ! -d log -o ! -d log/supervise ]
then
  echo "Error: $0 must be run from svscan."
  exit 1
fi

log="$1"

logdir="${SVCLOGDIR-/var/log}/$log"
confdir="./log/control"
dfltdir="${SVCLOGCONF-/etc/multilog}"

read() {
  local param=$1
  shift
  if [ -s $confdir/$param ]
  then
    head -1 $confdir/$param
  elif [ -s $dfltdir/$param ]
  then
    head -1 $dfltdir/param
  else
    echo "$@"
  fi
}

size=`read size 99999`
number=`read number 10`
owner=`read owner ""`

if [ -n "$owner" ]; then setuidgid="setuidgid $owner" fi

# The processor is a special case:
processor=""
if [ -x "$confdir/processor" ]
then
  processor="'!$confdir/processor'"
fi

if [ -x "$dfltdir/processor" ]
then
  processor="'!$dfltdir/processor' $processor"
fi

echo "exec $setuidgid multilog t n'$number' s'$size' $processor '$logdir'"
